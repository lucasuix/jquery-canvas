<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JQ Drawing Canvas</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="./lib/tools.js"></script>
    <script src="./lib/actions.js"></script>
    <link rel="stylesheet" href="./lib/css/style.css">
</head>
<body class="bg-dark">
    
     <div class="container mt-4">
        <div class="row">
            <div class="col-auto">
                    <div class="col btn-group" role="group" id="ferramentas">
                        <button id="lapis" class="btn btn-warning tool clicked">
                            <object class="button-svg" type="image/svg+xml" data="./src/tools/pencil.svg" width="40" height="40"></object>
                        </button>
                        <button id="borracha" class="btn btn-warning tool">
                            <object class="button-svg" type="image/svg+xml" data="./src/tools/eraser2.svg" width="40" height="40"></object>
                        </button>
                        <button id="retangulo" class="btn btn-warning tool">
                            <object class="button-svg" type="image/svg+xml" data="./src/tools/square.svg" width="40" height="40"></object>
                        </button>
                        <button id="retangulo_fill" class="btn btn-warning tool">
                            <object class="button-svg" type="image/svg+xml" data="./src/tools/square_filled.svg" width="40" height="40"></object>
                        </button>
                        <button id="elipse" class="btn btn-warning tool">
                            <object class="button-svg" type="image/svg+xml" data="./src/tools/elipse.svg" width="40" height="40"></object>
                        </button>
                        <button id="elipse_fill" class="btn btn-warning tool">
                            <object class="button-svg" type="image/svg+xml" data="./src/tools/elipse_filled.svg" width="40" height="40"></object>
                        </button>
                        <button id="linha" class="btn btn-warning tool">
                            <object class="button-svg" type="image/svg+xml" data="./src/tools/line.svg" width="40" height="40"></object>
                        </button>
                        <button id="balde" class="btn btn-warning tool">
                            <object class="button-svg" type="image/svg+xml" data="./src/tools/bucket2.svg" width="40" height="40"></object>
                        </button>
                    </div>
                </div>

                <div class="col-2">
                    <div class="row">
                        <div class="input-group">
                            <div class="input-group-text bg-warning">Brush Size</div>
                            <input type="decimal" class="form-control" id="brushSize_value" placeholder="5 px">
                        </div>
                    </div>
                    <div class="row">
                        <div class="d-flex justify-content-center">
                            <div class="col">
                                <input type="range" class="form-range" id="brushSize">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-auto d-flex stify-content-end">
                    <input type="color" id="brushColor">
                </div>

                <div class="col-auto">
                    <div class="container" id="colorbench">
                        <div class="row">
                            <div class="col-12">
                                <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#FFFFFF;stroke-width:2;stroke:#000000" id="#FFFFFF"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#F0F0F0;stroke-width:2;stroke:#000000" id="#F0F0F0"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#ff0000;stroke-width:2;stroke:#000000" id="#ff0000"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#00ff00;stroke-width:2;stroke:#000000" id="#00ff00"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#0000ff;stroke-width:2;stroke:#000000" id="#0000ff"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#ffff00;stroke-width:2;stroke:#000000" id="#ffff00"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#ff00ff;stroke-width:2;stroke:#000000" id="#ff00ff"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#00ffff;stroke-width:2;stroke:#000000" id="#00ffff"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#ffa500;stroke-width:2;stroke:#000000" id="#ffa500"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#ff0062;stroke-width:2;stroke:#000000" id="#ff0062"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#7f00ad;stroke-width:2;stroke:#000000" id="#7f00ad"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#ffd396;stroke-width:2;stroke:#000000" id="#ffd396"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#517b94;stroke-width:2;stroke:#000000" id="#517b94"/>
                                </svg>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#000000;stroke-width:2;stroke:#000000" id="#000000"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#BFBFBF;stroke-width:2;stroke:#000000" id="#BFBFBF"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#920000;stroke-width:2;stroke:#000000" id="#920000"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#008100;stroke-width:2;stroke:#000000" id="#008100"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#003e81;stroke-width:2;stroke:#000000" id="#003e81"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#5c5c00;stroke-width:2;stroke:#000000" id="#5c5c00"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#860086;stroke-width:2;stroke:#000000" id="#860086"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#00786e;stroke-width:2;stroke:#000000" id="#00786e"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#664200;stroke-width:2;stroke:#000000" id="#664200"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#4f001e;stroke-width:2;stroke:#000000" id="#4f001e"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#2b003b;stroke-width:2;stroke:#000000" id="#2b003b"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#544228;stroke-width:2;stroke:#000000" id="#544228"/>
                                </svg><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="20" height="20" style="fill:#1b3545;stroke-width:2;stroke:#000000" id="#1b3545"/>
                                </svg>
                            </div>
                        </div>

                    </div>
                </div>
    
                <div class="col-2">
                    <div class="btn-group" role="group" id="acoes">
                        <button id="undo" class="btn btn-warning action">
                            <object class="button-svg" type="image/svg+xml" data="./src/actions/undo.svg" width="40" height="40"></object>
                        </button>
                        <button id="redo" class="btn btn-warning action">
                            <object class="button-svg" type="image/svg+xml" data="./src/actions/redo.svg" width="40" height="40"></object>
                        </button>
                        <button id="limpar" class="btn btn-warning action"> Clear Canvas </button>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4 bg-dark-subtle p-2 rounded">
                <div class="col d-flex justify-content-center">
                    <canvas id="canvas" width="1080px" height="720px">
                    </canvas>
                </div>
            </div>
            
            <div class="row">
                <div class="col d-flex justify-content-between">
                    <span class="text-white-50"> Authored by Lucas Villani </span>
                    
                    <div class="btn-group" role="group">
                        <a href="https://github.com/lucasuix/jquery-canvas">
                            <button class="btn btn-dark"><svg role="img" width="30" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="#fafafa"><title>This project Github page</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></button>
                        </a>
                        <a href="https://www.linkedin.com/in/lucas-villani-a630832ba">
                            <button class="btn btn-dark"><svg role="img" width="30" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="#fafafa"><title>My LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></button>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    
    <script>
        const canvas = document.querySelector("canvas");
        ctx = canvas.getContext("2d");
        ctx.imageSmoothingEnabled = false;
        ctx.willReadFrequently = true;

        const ferramentas = document.getElementById("ferramentas");
        const brushSize = document.getElementById("brushSize");
        const brushSize_value = document.getElementById("brushSize_value");
        const acoes = document.getElementById("acoes");
        const colorbench = document.getElementById("colorbench");
        const cursorCircle = document.getElementById("cursorCircle");
        
        //Evento que ocorre no carregamento da página
        
        window.addEventListener("load", () => {
            //Seta o tamanho do canvas em relação a ele mesmo
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            ctx.fillStyle = "#fff"; // Define a cor de fundo como branco
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            //Resolve o problema da ferramenta balde não funcionar após um traço e undo para o canvas no estado de ínicio
            custom["snapshot"] = ctx.getImageData(0, 0, canvas.width, canvas.height);
            simpleDo.stack.shift();
            simpleDo.stack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
            
            //Inicia o deslizante Brushsize e seta os valores de ínicio
            brushSize.value = 5;
            brushSize.min = 1;
            brushSize.max = 100;
            
            //Seta valor de ínicio no seletor de cores
            document.getElementById("brushColor").value = "#000";
            
            //Coloca o estilo do botao da ferramenta do lápis como selecionada por padrão
            document.getElementById("lapis").classList.add("clicked");
        });
        

        //ferramentas
        const tools = {
            "lapis": new Pencil(),
            "borracha": new Eraser(),
            "retangulo": new Rectangle(),
            "retangulo_fill": new RectangleFill(),
            "elipse": new Ellipse(),
            "elipse_fill": new EllipseFill(),
            "linha": new Line(),
            "balde": new Bucket()
        };

        const custom = {
            //Dados gerais
            "brush_size": 5,
            "brush_color": "#000",
            
            //Dados para ferramentas: Retângulo, Linha, Círculo
            "prevX": 0,
            "prevY": 0,
            
            "snapshot": ctx.getImageData(0, 0, canvas.width, canvas.height),
            
            "canvas_size": {
                
                "width": ctx.canvas.width,
                "height": ctx.canvas.height
                
            },
            
            "limpo": true
        };
        

        //Ferramenta atual
        var current_tool = "lapis";
        const simpleDo = new SimpleDo(10, ctx.getImageData(0, 0, canvas.width, canvas.height));

        //para trocar qual é a ferramenta atual
        $(ferramentas).on("click", function (e) {
            
            //Removo o estilo selecionado do botao da ferramenta antiga
            document.getElementById(current_tool).classList.remove("clicked");
            current_tool = e.target.id;
            
            //Adiciono o estilo selecionado do botao da nova ferramenta
            document.getElementById(current_tool).classList.add("clicked");
        
        });
        
        $(brushSize_value).on("input blur", function () {
            
            custom["brush_size"] = $(this).val();
            
            if (custom["brush_size"] <= 0 ) custom["brush_size"] = 1;
            
            $(brushSize_value).attr("placeholder", custom["brush_size"] + " px");
            //Arruma o valor do input do type range
            $(brushSize).val(custom["brush_size"]);
                
        });

        //Para trocar o tamanho da ferramenta
        $(brushSize).on("input", function () {
            
            //Seta no custom
            custom["brush_size"] = $(this).val();
            
            //Arruma o input para ter aquele valor
            $(brushSize_value).val("");
            $(brushSize_value).attr("placeholder", custom["brush_size"] + " px");

            
            //Arruma o círculo para o usuário saber qual o tamanho do lápis corretamente
            //const circle_brushSize = document.getElementById("circle_brushSize");
            //circle_brushSize.setAttribute('r', custom["brush_size"] * 0.5);
        
        });
        
        //Para trocar a cor da ferramenta
        $(brushColor).on("input", function () { custom["brush_color"] = $(this).val(); });

        //Talvez seja melhor colocar o colorBench aqui e adicionar as cores padrão e pegar todo elemento por ID
        $(colorbench).on("click", function (e) {

            if (e.target.id == "brushColor") return;
            custom["brush_color"] = e.target.id;
            $("#brushColor").val(custom["brush_color"]);

        });
        
        $(acoes).on("click", function(e) {
            
            acao = e.target.id;
            
            switch (acao) {
                
                case "undo": 
                    simpleDo.undo(ctx);
                    break;
                    
                case "redo": 
                    simpleDo.redo(ctx);
                    break;
                    
                case "limpar":
                
                    //Limpar a tela é uma ação, mas só pode ser realizada uma vez (não faz sentido limpar um desenho que já foi limpo)
                    if (custom["limpo"]) break;
                    
                    //Do contrário realizamos a limpeza
                    ctx.fillStyle = "#fff"; // Define a cor de fundo como branco
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    simpleDo.action = true;
                    custom["limpo"] = true;
                    
                    simpleDo.pushAction(ctx.getImageData(0, 0, canvas.width, canvas.height));
                    break;
                    
                default:
                    break;
                
            }
        
        });

        //Evento que escuta quando o mouse é pressionado para baixo no canvas
        $(canvas).on('mousedown', function(e) {

            //Snapshot para criar efeito de deslize se necessário
            custom["snapshot"] = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            //Dizer ao simpleDo que realmente algo foi feito no desenho
            //Evitar que algo seja adicionado ao stack, sem um clique ter ocorrido na tela
            simpleDo.action = true;
            custom["limpo"] = false; //Se algo foi feito no canvas, então o desenho não está mais limpo
            
            //Ponto inicial
            custom["prevX"] = e.offsetX;
            custom["prevY"] = e.offsetY;
            
            ctx.beginPath(); //Posição inicial do mouse é o ínicio do trajeto
            
            tools[current_tool].setup(custom); //Preferências passadas pela ferramenta
            tools[current_tool].iniciar(ctx, e); //Preferências e funcionamento da ferramenta passado para o canvas 

            // Aplica a ferramenta no canvas
            $(canvas).on('mousemove', function(e) { tools[current_tool].aplicar(ctx, e); });
            
        });

        
        $(canvas).on('mouseup mouseleave', function(e) { $(canvas).off('mousemove'); simpleDo.pushAction(ctx.getImageData(0, 0, canvas.width, canvas.height)); });



    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
