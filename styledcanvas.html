<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="./tools.js"></script>
    <script src="./actions.js"></script>
    <link rel="stylesheet" href="./style.css">
</head>
<body>

    <div class="canvasholder">
        <div id="workbench">
            
            <div id="ferramentas">
            <button id="lapis" class="tool">
                <object class="button-svg" type="image/svg+xml" data="./src/tools/pencil.svg" width="40" height="40"></object>
            </button>
            <button id="borracha" class="tool">
                <object class="button-svg" type="image/svg+xml" data="./src/tools/eraser2.svg" width="40" height="40"></object>
            </button>
            <button id="retangulo" class="tool">
                <object class="button-svg" type="image/svg+xml" data="./src/tools/square.svg" width="40" height="40"></object>
            </button>
            <button id="retangulo_fill" class="tool">
                <object class="button-svg" type="image/svg+xml" data="./src/tools/square_filled.svg" width="40" height="40"></object>
            </button>
            <button id="elipse" class="tool">
                <object class="button-svg" type="image/svg+xml" data="./src/tools/elipse.svg" width="40" height="40"></object>
            </button>
            <button id="elipse_fill" class="tool">
                <object class="button-svg" type="image/svg+xml" data="./src/tools/elipse_filled.svg" width="40" height="40"></object>
            </button>
            <button id="linha" class="tool">
                <object class="button-svg" type="image/svg+xml" data="./src/tools/line.svg" width="40" height="40"></object>
            </button>
            <button id="balde" class="tool">
                <object class="button-svg" type="image/svg+xml" data="./src/tools/bucket2.svg" width="40" height="40"></object>
            </button>
            </div>
        
            <div id="acoes">
                <button id="undo" class="action">
                    <object class="button-svg" type="image/svg+xml" data="./src/actions/undo.svg" width="40" height="40"></object>
                </button>
                <button id="redo" class="action">
                    <object class="button-svg" type="image/svg+xml" data="./src/actions/redo.svg" width="40" height="40"></object>
                </button>
                <button id="limpar" class="action"> Limpar Desenho </button>
            </div>
            
            <div id="sizebench">
                <input type="range" id="brushSize">
                <svg width="100" height="100">
                    <circle id="circle_brushSize"cx="50" cy="50" r="2.5" fill="white" />
                </svg>
            </div>
        

            <div id="colorbench">

                <div class="colorRow">
                    <input type="color" id="brushColor">
                </div>

                <div class="colorRow">
                    <div class="colorSquare" name="white">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100" height="100" style="fill:#FFFFFF;stroke-width:2;stroke:#000000" id="#FFFFFF"/>
                        </svg>
                    </div>
                    <div class="colorSquare">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100" height="100" style="fill:#F0F0F0;stroke-width:2;stroke:#000000" id="#F0F0F0"/>
                        </svg>
                    </div>

                    <div class="colorSquare">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100" height="100" style="fill:#BFBFBF;stroke-width:2;stroke:#000000" id="#BFBFBF"/>
                        </svg>
                    </div>
                    <div id="#000000" class="colorSquare" name="black">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100" height="100" style="fill:#000000;stroke-width:2;stroke:#000000" id="#000000"/>
                        </svg>
                    </div>

                    <div class="colorSquare" name="red">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100" height="100" style="fill:#920000;stroke-width:2;stroke:#000000" id="#920000"/>
                        </svg>
                    </div>
                    <div class="colorSquare">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100" height="100" style="fill:#ff0000;stroke-width:2;stroke:#000000" id="#ff0000"/>
                        </svg>
                    </div>

                    <div class="colorSquare" name="green">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100" height="100" style="fill:#008100;stroke-width:2;stroke:#000000" id="#008100"/>
                        </svg>
                    </div>
                    <div id="#00fa00" class="colorSquare">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100" height="100" style="fill:#00fa00;stroke-width:2;stroke:#000000" id="#00fa00"/>
                        </svg>
                    </div>
                </div>

                <div class="colorRow">
                
                    <div class="colorSquare" name="blue">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100" height="100" style="fill:#003e81;stroke-width:2;stroke:#000000" id="#003e81"/>
                        </svg>
                    </div>
                    <div class="colorSquare">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100" height="100" style="fill:#0000ff;stroke-width:2;stroke:#000000" id="#0000ff"/>
                        </svg>
                    </div>

                    <div class="colorSquare" name="yellow">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100" height="100" style="fill:#5c5c00;stroke-width:2;stroke:#000000" id="#5c5c00"/>
                        </svg>
                    </div>
                    <div class="colorSquare">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100" height="100" style="fill:#ffff00;stroke-width:2;stroke:#000000" id="#ffff00"/>
                        </svg>
                    </div>

                    <div class="colorSquare" name="magenta">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100" height="100" style="fill:#860086;stroke-width:2;stroke:#000000" id="#860086"/>
                        </svg>
                    </div>
                    <div class="colorSquare">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100" height="100" style="fill:#ff00ff;stroke-width:2;stroke:#000000" id="#ff00ff"/>
                        </svg>
                    </div>

                    <div class="colorSquare" name="cyan">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100" height="100" style="fill:#008585;stroke-width:2;stroke:#000000" id="#008585"/>
                        </svg>
                    </div>
                    <div class="colorSquare">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100" height="100" style="fill:#00ffff;stroke-width:2;stroke:#000000" id="#00ffff"/>
                        </svg>
                    </div>
                </div>

            </div>
            
        </div>
        
        <canvas id="canvas" width="1080px" height="720px">
        </canvas>
    </div>

    
    <script>
        const canvas = document.querySelector("canvas");
        ctx = canvas.getContext("2d");
        ctx.imageSmoothingEnabled = false;
        ctx.willReadFrequently = true;

        const ferramentas = document.getElementById("ferramentas");
        const brushSize = document.getElementById("brushSize");
        const acoes = document.getElementById("acoes");
        const colorbench = document.getElementById("colorbench");

        //Evento que ocorre no carregamento da página
        
        window.addEventListener("load", () => {
            //Seta o tamanho do canvas em relação a ele mesmo
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            ctx.fillStyle = "#fff"; // Define a cor de fundo como branco
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            //Inicia o deslizante Brushsize e seta os valores de ínicio
            brushSize.value = 5;
            brushSize.min = 1;
            brushSize.max = 100;
            
            //Seta valor de ínicio no seletor de cores
            document.getElementById("brushColor").value = "#000";
            
            //Coloca o estilo do botao da ferramenta do lápis como selecionada por padrão
            document.getElementById("lapis").classList.add("clicked");
        });
        

        //ferramentas
        const tools = {
            "lapis": new Pencil(),
            "borracha": new Eraser(),
            "retangulo": new Rectangle(),
            "retangulo_fill": new RectangleFill(),
            "elipse": new Ellipse(),
            "elipse_fill": new EllipseFill(),
            "linha": new Line(),
            "balde": new Bucket()
        };

        const custom = {
            //Dados gerais
            "brush_size": 5,
            "brush_color": "#000",
            
            //Dados para ferramentas: Retângulo, Linha, Círculo
            "prevX": 0,
            "prevY": 0,
            
            "snapshot": ctx.getImageData(0, 0, canvas.width, canvas.height),
            
            "canvas_size": {
                
                "width": ctx.canvas.width,
                "height": ctx.canvas.height
                
            },
            
            "limpo": true
        };
        
        
        //$("#redo").prop('disabled', false); //Ativo função avançar
        //$("#undo").prop('disabled', true); //Desativo função voltar

        //Ferramenta atual
        var current_tool = "lapis";
        const simpleDo = new SimpleDo(10, ctx.getImageData(0, 0, canvas.width, canvas.height));

        //para trocar qual é a ferramenta atual
        $(ferramentas).on("click", function (e) {
            
            //Removo o estilo selecionado do botao da ferramenta antiga
            document.getElementById(current_tool).classList.remove("clicked");
            current_tool = e.target.id;
            
            //Adiciono o estilo selecionado do botao da nova ferramenta
            document.getElementById(current_tool).classList.add("clicked");
        
        });

        //Para trocar o tamanho da ferramenta
        $(brushSize).on("input", function () {
            
            //Seta no custom
            custom["brush_size"] = $(this).val(); 
            
            //Arruma o círculo para o usuário saber qual o tamanho do lápis corretamente
            const circle_brushSize = document.getElementById("circle_brushSize");
            circle_brushSize.setAttribute('r', custom["brush_size"] * 0.5);
        
        });
        
        //Para trocar a cor da ferramenta
        $(brushColor).on("input", function () { custom["brush_color"] = $(this).val(); });

        //Talvez seja melhor colocar o colorBench aqui e adicionar as cores padrão e pegar todo elemento por ID
        $(colorbench).on("click", function (e) {

            console.log(e.target.id);
            if (e.target.id == "brushColor") return;
            custom["brush_color"] = e.target.id;

        });
        
        $(acoes).on("click", function(e) {
            
            acao = e.target.id;
            
            switch (acao) {
                
                case "undo": 
                    simpleDo.undo(ctx);
                    break;
                    
                case "redo": 
                    simpleDo.redo(ctx);
                    break;
                    
                case "limpar":
                
                    //Limpar a tela é uma ação, mas só pode ser realizada uma vez (não faz sentido limpar um desenho que já foi limpo)
                    if (custom["limpo"]) break;
                    
                    //Do contrário realizamos a limpeza
                    ctx.fillStyle = "#fff"; // Define a cor de fundo como branco
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    simpleDo.action = true;
                    custom["limpo"] = true;
                    
                    simpleDo.pushAction(ctx.getImageData(0, 0, canvas.width, canvas.height));
                    break;
                    
                default:
                    break;
                
            }
        
        });

        //Evento que escuta quando o mouse é pressionado para baixo no canvas
        $(canvas).on('mousedown', function(e) {

            //Snapshot para criar efeito de deslize se necessário
            custom["snapshot"] = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            //Dizer ao simpleDo que realmente algo foi feito no desenho
            //Evitar que algo seja adicionado ao stack, sem um clique ter ocorrido na tela
            simpleDo.action = true;
            custom["limpo"] = false; //Se algo foi feito no canvas, então o desenho não está mais limpo
            
            //Ponto inicial
            custom["prevX"] = e.offsetX;
            custom["prevY"] = e.offsetY;
            
            ctx.beginPath(); //Posição inicial do mouse é o ínicio do trajeto
            
            tools[current_tool].setup(custom); //Preferências passadas pela ferramenta
            tools[current_tool].iniciar(ctx, e); //Preferências e funcionamento da ferramenta passado para o canvas 

            // Aplica a ferramenta no canvas
            $(canvas).on('mousemove', function(e) { tools[current_tool].aplicar(ctx, e); });
            
        });

        
        $(canvas).on('mouseup mouseleave', function(e) { $(canvas).off('mousemove'); simpleDo.pushAction(ctx.getImageData(0, 0, canvas.width, canvas.height)); });



    </script>
</body>
</html>
